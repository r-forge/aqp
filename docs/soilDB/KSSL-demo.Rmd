```{r setup, echo=FALSE, results='hide'}
# setup
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', dpi=100, fig.align='center', dev='CairoPNG', tidy=FALSE, verbose=FALSE)
options(width=100, stringsAsFactors=FALSE)
```

Getting and Comparing KSSL Data
===============================
`r format(Sys.time(), "%Y-%m-%d")`
Dylan Beaudette

### Introduction
This document demonstrates how to use the [soilDB](https://r-forge.r-project.org/scm/viewvc.php/*checkout*/docs/soilDB/soilDB-Intro.html?root=aqp) package to download [KSSL](http://ncsslabdatamart.sc.egov.usda.gov/) data from SoilWeb. These data are from the June 2012 snapshot, and will be updated as future snapshots are released. Comparisons are made via graphical summaries of key soil properties with depth, using [data structures and functions](https://r-forge.r-project.org/scm/viewvc.php/*checkout*/docs/aqp/aqp-intro.html?root=aqp) from the [aqp](http://aqp.r-forge.r-project.org/) package.

### Installation
With a recent version of R (>= 2.15), it is possible to get all of the packages that this tutorial depends on via:
```{r install-deps, eval=FALSE}
# run these commands in the R console
install.packages('maps', dep=TRUE) # stable version from CRAN + dependencies
install.packages('soilDB', dep=TRUE) # stable version from CRAN + dependencies
install.packages('soilDB', repos="http://R-Forge.R-project.org", type='source') # most recent copy from r-forge
```

### Getting KSSL Data

Data can be queried by fuzzy-matching of *correlated* series name or using a geographic bounding-box in WGS84 referenced coordinates. Series name matching is case-insensitive and will return results based on partial matches. For example, querying for "adco" will also return the soil named "adco taxadjunct". Note that series name is based on the "correlated as" field (from KSSL snapshot) when present.  The "sampled as" classification was promoted to "correlated as" if the "correlated as" classification was missing. See `?fetchKSSL()` for details. In this example, we are downloading KSSL data for the [Auburn](https://soilseriessc.egov.usda.gov/OSD_Docs/A/AUBURN.html), [Argonaut](https://soilseries.sc.egov.usda.gov/OSD_Docs/A/ARGONAUT.html), and [Sobrante](https://soilseries.sc.egov.usda.gov/OSD_Docs/S/SOBRANTE.html) soils; commonly found on metavolcanic rocks within the Sierra Nevada Foothill region of California.
```{r get-data, fig.width=5, fig.height=5}
# load libraries
library(soilDB)
library(plyr)
library(lattice)
library(maps)

# define plotting style
tps <- list(superpose.line=list(col=c('RoyalBlue', 'DarkRed', 'DarkGreen'), lwd=2))

# fetch KSSL data by fuzzy-matching of series name
auburn <- fetchKSSL('auburn')
sobrante <- fetchKSSL('sobrante')
argonaut <- fetchKSSL('argonaut')

# generate a basemap of northern California, with county boundaries
map('county', 'California', xlim=c(-123.25, -119), ylim=c(37.5, 41))
# add long/lat axes
map.axes()
# add locations of Auburn
points(y ~ x, data=site(auburn), pch=21, bg='RoyalBlue')
# add locations of Sobrante
points(y ~ x, data=site(sobrante), pch=21, bg='DarkRed')
# add locations of Argonaut
points(y ~ x, data=site(argonaut), pch=21, bg='DarkGreen')
# add a simple legend
legend('topright', pch=21, pt.bg=c('RoyalBlue', 'DarkRed', 'DarkGreen'), legend=c('Auburn', 'Sobrante', 'Argonaut'), bty='n')
```


### Combining Data
Since the results from `fetchKSSL()` function always returns data in the same format, it is possible to stack the results of several KSSL queries using `rbind()`.
```{r combine-data}
# check "correlated as" names from each object
table(auburn$correlated_as)
table(sobrante$correlated_as)
table(argonaut$correlated_as)

# since there are multiple permuations of each, normalize soil series name by replacement
auburn$correlated_as <- 'Auburn'
sobrante$correlated_as <- 'Sobrante'
argonaut$correlated_as <- 'Argonaut'

# stack datasets into a new SoilProfileCollection
g <- rbind(argonaut, auburn, sobrante)

# tabulate number of pedons by normalized series name
table(g$correlated_as)
```


### Aggregation
The `slab()` function is used to aggregate selected variables within collections of soil profiles along depth-slices. In this case, we aggregate clay, pH, and base saturation at pH 8.2 along 1-cm thick slices and within groups defined by the variable 'correlated_as'. See `?slab()` for details on how this function can be used.
```{r aggregate}
g.slab <- slab(g, correlated_as ~ clay + ph_h2o + bs82)

# inspect stacked data structure
str(g.slab)
```


### Refine Labels
It is convenient to know how many pedons there are within each collection-- therefore, we append this value to the series name. Using the same approach, we can rename the soil properties with more useful descriptions and units of measure.
```{r rename}
# re-name soils with series name + number of pedons-- order is critical !
new.levels <- c('Auburn', 'Sobrante', 'Argonaut')
new.labels <- paste(new.levels, ' [', c(length(auburn), length(sobrante), length(argonaut)), ' pedons]', sep='')
g.slab$correlated_as <- factor(g.slab$correlated_as, levels=new.levels, labels=new.labels)

# new names should match the order in:
levels(g.slab$variable)

# re-name soil property labels-- order is critical !
levels(g.slab$variable) <- c('Clay (%)', 'pH 1:1 H2O', 'Base Saturation at pH 8.2 (%)')
```


### Graphically Compare
The slice-wise median and 25th/75th percentiles are reasonable estimations of central tendency and spread. "Contributing fraction" values (% of pedons with data at a given depth) are printed along the right-hand side of each panel. These values provide both an indication of how deep the soils are, and, how much confidence can be placed in the aggregate data at any given depth.
```{r plot, fig.width=9, fig.height=6}
# plot grouped, aggregate data
xyplot(top ~ p.q50 | variable, groups=correlated_as, data=g.slab, ylab='Depth',
			 xlab='median bounded by 25th and 75th percentiles',
			 lower=g.slab$p.q25, upper=g.slab$p.q75, ylim=c(155,-5),
			 panel=panel.depth_function, alpha=0.25, sync.colors=TRUE,
			 prepanel=prepanel.depth_function,
			 cf=g.slab$contributing_fraction,
			 strip=strip.custom(bg=grey(0.85)),
			 layout=c(3,1), scales=list(x=list(alternating=1, relation='free'), y=list(alternating=3)),
			 par.settings=tps,
			 auto.key=list(columns=3, lines=TRUE, points=FALSE)
)

# plot contributing fraction values
xyplot(top ~ contributing_fraction | variable, groups=correlated_as, data=g.slab, ylab='Depth',
             xlab='Fraction of Non-Missing Data',
             panel=panel.depth_function, ylim=c(155,-5),
             strip=strip.custom(bg=grey(0.85)),
             layout=c(3,1), scales=list(x=list(alternating=1), y=list(alternating=3)),
             par.settings=tps,
             auto.key=list(columns=3, lines=TRUE, points=FALSE)
)
```


----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")` and `soilDB` version `r utils::packageDescription("soilDB", field="Version")`.