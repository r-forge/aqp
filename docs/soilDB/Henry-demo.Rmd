---
output:
  html_document:
    mathjax: null
    jquery: null
    smart: no
---

```{r setup, echo=FALSE, results='hide', warning=FALSE}
# setup
library(knitr, quietly=TRUE)
library(printr, quietly=TRUE)
opts_chunk$set(message=FALSE, warning=FALSE, background='#F7F7F7', fig.align='center', fig.retina=2, dev='png', tidy=FALSE, verbose=FALSE)
options(width=100, stringsAsFactors=FALSE)
```

Henry Mount Soil Climate Database Tutorial
==========================================
`r format(Sys.time(), "%Y-%m-%d")`
D.E. Beaudette


## Introduction
This document demonstrates how to use the [soilDB](https://r-forge.r-project.org/scm/viewvc.php/*checkout*/docs/soilDB/soilDB-Intro.html?root=aqp) package to download data from the Henry Mount soil climate database.


### Data Collection


### Current Work and Future Plans



## Setup R Environment
With a recent version of R (>= 2.15), it is possible to get all of the packages that this tutorial depends on via:
```{r install-deps, eval=FALSE}
# run these commands in the R console
install.packages('plyr', dep=TRUE) # stable version from CRAN + dependencies
install.packages('reshape2', dep=TRUE) # stable version from CRAN + dependencies
install.packages('dismo', dep=TRUE) # stable version from CRAN + dependencies
install.packages('soilDB', dep=TRUE) # stable version from CRAN + dependencies
install.packages('soilDB', repos="http://R-Forge.R-project.org", type='source') # most recent copy from r-forge
```


## Getting and Viewing Data
Data can be queried by:
 
 * project (typically a soil survey area, 'CA630')
 * NASIS user site ID
 
```{r get-data, fig.width=6, fig.height=7}
library(reshape2)
library(soilDB)
library(lattice)
library(plyr)
library(dismo)

# get data from Sequoia / Kings Canyon soil survey
x <- fetchHenry(project='CA792')

# quick listing of site names, IDs, and coordinates
head(as.data.frame(x$sites)[, c('user_site_id', 'name', 'serial_number', 'wgs84_latitude', 'wgs84_longitude')])
```


### Overlay Points on a Google Map
```{r map-data, eval=FALSE}
g <- gmap(x$sites)
plot(g, interpolate=TRUE)
points(Mercator(x$sites), col='red')
```


### Plot Data
Note that there are gaps in the data: between site visits and lack of synchronization of site visits with start/end of the year.
```{r plot-time-series, fig.width=10, fig.height=7}
xyplot(sensor_value ~ date_time | id, data=x$soiltemp, type=c('l', 'g'), as.table=TRUE)
```



## Data Summaries

In the presence of missing data, MAST calculations will be biased towards those data that are not missing. For example, a block of missing data in January will result in an estimated MAST that is too high due to the missing data from the middle of winter. It is possible to estimate (mostly) unbiased MAST values in the presence of some missing data by averaging multiple years of data by Julian day.  This approach will generate reasonable summaries in the presence of missing data, as long as data gaps are "covered" by corresponding data from another year. The longer the period of record and shorter the data gaps, the better.

The following custom function (copy / paste into your R console) is a starting point for computing un-biased estimates of MAST, mean summer, and mean winter temperatures.
```{r custom-function}
summarizeSoilTemperature <- function(s) {
  # compute summaries by DOY:
  # n: number of non-NA records
  # daily.mean: mean of non-NA values
  d <- ddply(s, c('id', 'doy'), summarize, n=length(na.omit(sensor_value)), 
             daily.mean=mean(sensor_value, na.rm=TRUE))
  
  # convert DOY -> month
  d$month <- format(as.Date(as.character(d$doy), format="%j"), "%b")
  d$season <- soilDB:::.month2season(d$month)
  
  # compute unbiased MAST, number of obs
  d.mast <- ddply(d, 'id', summarize, obs=sum(n), MAST=round(mean(daily.mean, na.rm=TRUE), 2))
    
  # compute unbiased seasonal averages
  d.seasonal.long <- ddply(d[which(d$season %in% c('Winter', 'Summer')), ], c('season', 'id'), 
  summarize, seasonal.mean.temp=round(mean(daily.mean, na.rm=TRUE), 2))
  
  # convert seasonal avgs to wide format
  d.season <- dcast(d.seasonal.long, id ~ season, value.var = 'seasonal.mean.temp')
  
  # combine columns
  d.summary <- join(d.mast, d.season, by = 'id')
  
  return(d.summary)
}
```



Compute un-biased summaries in the presence of missing data.
```{r data-summary, fig.width=6, fig.height=7}
summarizeSoilTemperature(x$soiltemp)
```


Compare these biased estimates generates from the raw data.
```{r biased-data-summary, fig.width=6, fig.height=7}
ddply(x$soiltemp, c('id'), summarize, MAST=mean(sensor_value, na.rm=TRUE))
```



### Additional Ideas

1. Get the number of non-missing observations for each site and year:
```{r additional-examples}
# get period of record for each, not including NA-padding
ddply(x$soiltemp, c('id', 'year'), function(i) {
  idx <- which(!is.na(i$sensor_value))
  start.date <- min(i$date_time[idx], na.rm=TRUE)
  end.date <- max(i$date_time[idx], na.rm=TRUE)
  return(data.frame(start.date, end.date, n.obs=length(idx)))
  })
```





----------------------------
This document is based on `aqp` version `r utils::packageDescription("aqp", field="Version")` and `soilDB` version `r utils::packageDescription("soilDB", field="Version")`.

